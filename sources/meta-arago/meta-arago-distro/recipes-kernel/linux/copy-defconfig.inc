CONFIG_NAME ?= "tisdk_${MACHINE}${ARAGO_KERNEL_SUFFIX}_defconfig"

# Copy the configuration file used during the SDK build in Arago to
# the kernel sources to be packaged into the sourceipk.  Then call
# the function to build the sourceipk again.  This is done as a
# do_compile_prepend so that we can pick up any changes to the
# defconfig thay may have been done by the sanitizer code.
do_configure_append() {
    cp ${B}/.config ${S}/arch/${ARCH}/configs/${CONFIG_NAME}

    # Remove defconfig generated by defconfig_builder to avoid confusion. This
    # may not match the config used in the build due to KERNEL_CONFIG_FRAGMENTS.
    config=`cat ${WORKDIR}/defconfig | grep use-tisdk-config | cut -d= -f2`
    if [ -n "$config" ]
    then
        rm ${S}/arch/${ARCH}/configs/${config}_defconfig
    fi
}

# Move create_srcipk task so that the release defconfig is included.
deltask do_create_srcipk
addtask create_srcipk after do_configure before do_compile
